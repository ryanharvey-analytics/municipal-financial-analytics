---
title: "Budget Report — Baseline + Dumbbell"
output:
  html_document:
    toc: true
    theme: flatly
params:
  excel_path: "C:/Users/rharvey/OneDrive/RStudio/Quarterly Report FY2026.xlsx"
  fund_sheet: "Sheet1"
  fund_range: "B2:F8"    # Fund | Rev Budget | Rev Actual | Exp Budget | Exp Actual
  dept_sheet: "Sheet1"
  dept_range: "B22:E31"  # Dept | Exp Budget | Exp Actual
  year_elapsed: .25
  show_surplus_lollipop: true   # OPTIONAL: dollars view per fund
  show_dept_bullet: true        # OPTIONAL: bullet chart vs target
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(janitor)
library(scales)
library(stringr)

# House style + colorblind-friendly palette
theme_city <- function(base_size = 14){
  theme_minimal(base_size = base_size) +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      panel.grid.minor = element_blank(),
      plot.margin = margin(8, 12, 8, 8)
    )
}
col_rev <- "#0072B2"   # Revenues (Okabe-Ito blue)
col_exp <- "#E69F00"   # Expenditures (Okabe-Ito orange)
col_target <- "darkgreen"  # dashed target line
```

# Load Data (Excel Direct)
```{r load-data}
raw_fund <- read_excel(params$excel_path, sheet = params$fund_sheet, range = params$fund_range) |>
  clean_names()

fund <- raw_fund |>
  rename(
    fund        = 1,
    rev_budget  = 2,
    rev_actual  = 3,
    exp_budget  = 4,
    exp_actual  = 5
  ) |>
  mutate(across(2:5, ~ readr::parse_number(as.character(.x)))) |>
  mutate(
    rev_pct = if_else(rev_budget > 0, rev_actual / rev_budget, 0),
    exp_pct = if_else(exp_budget > 0, exp_actual / exp_budget, 0),
    surplus = rev_actual - exp_actual,
    fund_chr = as.character(fund)
  ) |>
  filter(!is.na(fund_chr), nchar(trimws(fund_chr)) > 0) |>
  mutate(fund = factor(fund_chr, levels = fund_chr))

raw_dept <- read_excel(params$excel_path, sheet = params$dept_sheet, range = params$dept_range) |>
  clean_names()

dept <- raw_dept |>
  select(1:3) |>
  rename(
    dept       = 1,
    exp_budget = 2,
    exp_actual = 3
  ) |>
  mutate(
    exp_budget = readr::parse_number(as.character(exp_budget)),
    exp_actual = readr::parse_number(as.character(exp_actual)),
    exp_pct    = if_else(exp_budget > 0, exp_actual/exp_budget, 0),
    dept_chr   = as.character(dept)
  ) |>
  filter(!is.na(dept_chr), nchar(trimws(dept_chr)) > 0) |>
  mutate(dept = factor(dept_chr, levels = dept_chr))
```

# Baseline Charts

## Funds — Revenues & Expenditures (% of Budget)
```{r chart-fund}
year_line <- params$year_elapsed

fund_long <- fund |>
  select(fund, rev_pct, exp_pct) |>
  pivot_longer(cols = c(rev_pct, exp_pct),
               names_to = "type", values_to = "pct") |>
  mutate(type = recode(type, rev_pct = "Revenues", exp_pct = "Expenditures"),
         fund_label = str_wrap(as.character(fund), 18))

ggplot(fund_long, aes(fund_label, pct, fill = type)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  geom_text(aes(label = percent(pct, accuracy = 0.1)),
            position = position_dodge(width = 0.7), vjust = -0.35, size = 3.6) +
  geom_hline(yintercept = year_line, linetype = "dashed", colour = col_target, linewidth = 0.9) +
  annotate("text", x = 0.6, y = year_line + 0.02, label = "25%", hjust = 0, size = 3.6, colour = col_target) +
  scale_y_continuous(
  labels = scales::percent_format(accuracy = 1),
  limits = c(0, 0.50)
) +
  scale_fill_manual(values = c(Revenues = col_rev, Expenditures = col_exp)) +
  labs(title = "Revenues & Expenditures — % of Budget by Fund",
       x = NULL, y = "% of Budget", fill = NULL) +
  theme_city() +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 45, hjust = 1))
```

## Departments — % of Budget Spent
```{r chart-dept}
dept_plot <- dept |>
  arrange(desc(exp_pct)) |>
  mutate(
    over = exp_pct > year_line,
    dept_label = str_wrap(as.character(dept), 22)
  )

ggplot(dept_plot, aes(reorder(dept_label, exp_pct), exp_pct, fill = over)) +
  geom_col(width = 0.65) +
  geom_text(aes(label = percent(exp_pct, accuracy = 0.1)),
            hjust = -0.1, size = 3.4) +
  geom_hline(yintercept = year_line, linetype = "dashed", colour = col_target, linewidth = 0.9) +
  scale_y_continuous(labels = percent_format(accuracy = 1),
                     limits = c(0, 0.4)) +
  scale_fill_manual(values = c(`TRUE` = col_exp, `FALSE` = col_rev),
                    labels = c(`TRUE` = "Over target", `FALSE` = "At/under")) +
  labs(title = "General Fund Expenditures — % of Budget by Department",
       x = NULL, y = "% of Budget", fill = NULL) +
  coord_flip() +
  theme_city() +
  theme(legend.position = "right")
```

# Extra Visual (the one you liked)

## Dumbbell — Revenues vs Expenditures by Fund
```{r dumbbell}
db <- fund |>
  transmute(fund = str_wrap(as.character(fund), 18),
            rev_pct = rev_pct, exp_pct = exp_pct)

ggplot(db) +
  geom_segment(aes(x = exp_pct, xend = rev_pct, y = fund, yend = fund), colour = "grey60", linewidth = 1) +
  geom_point(aes(x = exp_pct, y = fund), colour = col_exp, size = 3) +
  geom_point(aes(x = rev_pct, y = fund), colour = col_rev, size = 3) +
  geom_vline(xintercept = year_line, linetype = "dashed", colour = col_target) +
  scale_x_continuous(
  labels = scales::percent_format(accuracy = 1),
  limits = c(0, 0.40)   # or 0.25 or whatever you want
) +
  labs(title = "Dumbbell — Revenues vs Expenditures by Fund",
       x = "% of Budget", y = NULL) +
  theme_city()
```

# Optional (toggle on in YAML)

## Surplus Lollipop — Dollars per Fund
```{r lollipop, eval=params$show_surplus_lollipop}
lop <- fund |>
  transmute(fund = str_wrap(as.character(fund), 18),
            surplus = rev_actual - exp_actual) |>
  arrange(surplus)

ggplot(lop, aes(x = surplus, y = reorder(fund, surplus))) +
  geom_segment(aes(x = 0, xend = surplus, yend = reorder(fund, surplus)), colour = "grey70") +
  geom_point(size = 3, colour = ifelse(lop$surplus >= 0, col_rev, col_exp)) +
  scale_x_continuous(labels = dollar_format()) +
  labs(title = "Surplus (Dollars) by Fund", x = "Dollars", y = NULL) +
  theme_city()
```

## Department Bullet — % Spent vs 100%
```{r bullet, eval=params$show_dept_bullet}
# Bullet-style: background reference bar at 100%, foreground at actual %
bullet <- dept |>
  transmute(dept = str_wrap(as.character(dept), 22), pct = exp_pct) |>
  arrange(pct)

ggplot(bullet, aes(y = reorder(dept, pct))) +
  geom_col(aes(x = 1), fill = "grey90", width = 0.7) +
  geom_col(aes(x = pct), fill = col_exp, width = 0.4) +
  geom_vline(xintercept = params$year_elapsed, linetype = "dashed", colour = col_target) +
  scale_x_continuous(labels = percent_format(1), limits = c(0, .40)) +
  labs(title = "Department Bullet Chart — Expenditures vs Budget", x = "% of Budget", y = NULL) +
  theme_city()
```
